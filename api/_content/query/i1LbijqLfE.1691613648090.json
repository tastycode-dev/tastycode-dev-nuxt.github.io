{"_path":"/blog/tasty-cpp-memory-layout-of-std-string","_dir":"blog","_draft":false,"_partial":false,"_locale":"","_empty":false,"title":"Tasty C++ – Memory Layout of std::string","description":"Learn about memory layout of std::string in c++ standard libraries: MSVC STL, libstdc++, libc++.","author":"Oleksandr Gituliar","date":"2023-08-07T00:00:00.000Z","body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For a professional C++ developer, it's crucial to understand memory organization of the data\nstructures and complexity of their operations. This is especially important when working with the\nC++ Standard Library. In this post of Tasty C++ series we'll look under the hood of "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::string"}]},{"type":"text","value":",\nso that you can work with C++ strings more effectively when designing your code and data structures."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In C++, "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::string"}]},{"type":"text","value":" is a sequence of characters that are stored in the buffer that spans a\n"},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"contiguous"}]},{"type":"text","value":" memory area. This means that individual characters can be efficiently accessed by index\nat O(1) time. The C++ Standard imposes other requirements on the complexity of common operations\nwith strings. However, it doesn't specify how exactly "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::string"}]},{"type":"text","value":" should be implemented."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In practice, various implementations of the C++ Standard Library use considerably different\napproaches. For example, the result of "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"sizeof(std::string)"}]},{"type":"text","value":" depends on what library is used."}]},{"type":"element","tag":"h2","props":{"id":"long-strings"},"children":[{"type":"text","value":"Long Strings"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Usually, to fully represent its internal state, "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::string"}]},{"type":"text","value":" needs three pieces of information:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Size"}]},{"type":"text","value":" – the current number of characters in the string."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Buffer"}]},{"type":"text","value":" – the pointer to the memory buffer where characters are stored."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Capacity"}]},{"type":"text","value":" – the max number of character the buffer can fit."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In fact, the "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"capacity"}]},{"type":"text","value":" is not required. We can use "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"size"}]},{"type":"text","value":" and "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"buffer"}]},{"type":"text","value":" only, but when the string\ngrows, a new buffer should be allocated on the heap (because we can't tell how many extra characters\nthe current buffer can fit). Since heap allocation is slow, such allocations are avoided by tracking\nthe buffer capacity."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Following this logic, we could implement a C++ string as:"}]},{"type":"element","tag":"code","props":{"className":["language-cpp"],"code":"class MyString {\n    size_t    m_size;\n    char *    m_buffer;\n    size_t    m_capacity;\n}\n","language":"cpp","meta":""},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-970031"},"children":[{"type":"text","value":"MyString"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"size_t"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"    m_size;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"char"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"    m_buffer;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"size_t"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"    m_capacity;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"}"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"MyString"}]},{"type":"text","value":" occupies 24 bytes, which is only 3x more than "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"fundamental types"}]},{"type":"text","value":" such as "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"void *"}]},{"type":"text","value":",\n"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"size_t"}]},{"type":"text","value":", or "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"double"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's see how things look in reality. In the "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"most popular implementations"}]},{"type":"text","value":" of the C++ Standard\nLibrary the size of "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::string"}]},{"type":"text","value":" object is the following:"}]},{"type":"element","tag":"table","props":{},"children":[{"type":"element","tag":"thead","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"th","props":{"align":null},"children":[{"type":"text","value":"C++ Standard Library"}]},{"type":"element","tag":"th","props":{"align":null},"children":[{"type":"text","value":"Size of std::string()"}]}]}]},{"type":"element","tag":"tbody","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"text","value":"MSVC STL"}]},{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"text","value":"32 bytes"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"text","value":"GCC libstdc++"}]},{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"text","value":"32 bytes"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"text","value":"LLVM libc++"}]},{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"text","value":"24 bytes"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To our surprise, only "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"LLVM"}]},{"type":"text","value":" allocates expected "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"24 bytes"}]},{"type":"text","value":" for "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::string"}]},{"type":"text","value":". The other two,\n"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"MSVC"}]},{"type":"text","value":" and "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"GCC"}]},{"type":"text","value":", allocate "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"32 bytes"}]},{"type":"text","value":" for the same string. (For completeness, note that in the\n"},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"debug mode"}]},{"type":"text","value":" MSVC allocates 40 bytes for "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::string"}]},{"type":"text","value":".)"}]},{"type":"element","tag":"h2","props":{"id":"short-strings"},"children":[{"type":"text","value":"Short Strings"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's get some intuition about why various implementation allocate different amount of memory for\nthe same object. In fact, 24 or 32 bytes is already enough to fit a relatively big string, with no\nneed to allocate dynamic memory (and free it afterwards, which is costly as well). The trick, called\n"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Small String Optimization"}]},{"type":"text","value":" (aka SSO), is to store string characters in the memory dedicated for\nthe size, capacity, and data pointer fields. Not sure this technique is part of the C++ Standard,\nbut for sure it's popular among various implementations."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Without going into much technicalities of SSO, let's mention two points worth to remember."}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"How big are short strings?"}]},{"type":"text","value":" It seems obvious that every implementation is free to extend\ninternal buffer for a small string far beyond required 24 bytes. This is why "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::string"}]},{"type":"text","value":" in\nMSVC and GCC is 32 bytes. However, the result of "},{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::string().capacity()"}]}]},{"type":"text","value":" is:"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"table","props":{},"children":[{"type":"element","tag":"thead","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"th","props":{"align":null},"children":[{"type":"text","value":"C++ Standard Library"}]},{"type":"element","tag":"th","props":{"align":null},"children":[{"type":"text","value":"Capacity of std::string()"}]}]}]},{"type":"element","tag":"tbody","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"text","value":"MSVC STL"}]},{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"text","value":"15 chars"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"text","value":"GCC libstdc++"}]},{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"text","value":"15 chars"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"text","value":"LLVM libc++"}]},{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"text","value":"22 chars"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Again, LLVM version seems to beat MSVC and GCC, since for a smaller memory usage (24 bytes) it's\nable to store longer strings (22 chars). (In fact, it's possible to fully utilize the memory and\nfit 23 chars + "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"'\\0'"}]},{"type":"text","value":".)"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"How fast are short strings?"}]},{"type":"text","value":" In this particular case, utilizing more space is not for\nfree. The more characters we pack into a string's memory area, the more CPU operations we have to\nrun. For LLVM, with its superior memory efficiency, even such a simple call as "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"size()"}]},{"type":"text","value":" requires\nto check if the string is short or long. This sort of conditions might slow down a calculation\npipeline."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A simple example of "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"size()"}]},{"type":"text","value":" method clearly demonstrates this point. (BTW, this is one of\nthe most commonly used method of "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::string"}]},{"type":"text","value":".)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"GCC stdlibc++"}]},{"type":"text","value":" code (see "},{"type":"element","tag":"a","props":{"href":"https://godbolt.org/z/7nYe9rWdE","rel":["nofollow"]},"children":[{"type":"text","value":"https://godbolt.org/z/7nYe9rWdE"}]},{"type":"text","value":") directly copies string's size into\nthe output register:"}]},{"type":"element","tag":"table","props":{},"children":[{"type":"element","tag":"thead","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"th","props":{"align":null},"children":[{"type":"text","value":"Example"}]},{"type":"element","tag":"th","props":{"align":null},"children":[{"type":"text","value":"GCC libstdc++"}]}]}]},{"type":"element","tag":"tbody","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"element","tag":"img","props":{"src":"/img/string-size-src.png"},"children":[]}]},{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"element","tag":"img","props":{"src":"/img/string-size-gcc.png"},"children":[]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"LLVM libc++"}]},{"type":"text","value":" code (see "},{"type":"element","tag":"a","props":{"href":"https://godbolt.org/z/xM349cG5P","rel":["nofollow"]},"children":[{"type":"text","value":"https://godbolt.org/z/xM349cG5P"}]},{"type":"text","value":") at first checks if the string is short\nand then calculates its size."}]},{"type":"element","tag":"table","props":{},"children":[{"type":"element","tag":"thead","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"th","props":{"align":null},"children":[{"type":"text","value":"Example"}]},{"type":"element","tag":"th","props":{"align":null},"children":[{"type":"text","value":"LLVM libc++"}]}]}]},{"type":"element","tag":"tbody","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"element","tag":"img","props":{"src":"/img/string-size-src.png"},"children":[]}]},{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"element","tag":"img","props":{"src":"/img/string-size-llvm.png"},"children":[]}]}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Eventually, it's hard to say which approach is more efficient. Now, that you know the difference,\nthe best advice here is to experiment with various implementations and benchmark your particular use\ncase."}]},{"type":"element","tag":"h2","props":{"id":"memory-allocation-policy"},"children":[{"type":"text","value":"Memory Allocation Policy"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Finally, let's see how "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::string"}]},{"type":"text","value":" grows its internal buffer when it's time to allocate more\nmemory. Some "},{"type":"element","tag":"a","props":{"href":"https://github.com/gcc-mirror/gcc/blob/master/libstdc%2B%2B-v3/include/bits/basic_string.tcc#L142","rel":["nofollow"]},"children":[{"type":"text","value":"comments in the GCC\nsources"}]},{"type":"text","value":",\nmentioned "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"amortized linear time requirement"}]},{"type":"text","value":" and "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"exponential growth policy"}]},{"type":"text","value":". Not clear if this is\ninternal GCC decision or part of the C++ Standard. In any case, all three implementations use\nexponential growth, so that "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"MSVC"}]},{"type":"text","value":" has "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"1.5x factor"}]},{"type":"text","value":" growth, while "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"GCC"}]},{"type":"text","value":" and "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"LLVM"}]},{"type":"text","value":" use "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"2x\nfactor"}]},{"type":"text","value":". Below are some examples with more explicit (but simplified) code:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"MSVC STL"}]}]},{"type":"element","tag":"code","props":{"className":["language-cpp"],"code":"size_t newCapacity(size_t newSize, size_t oldCap) {\n    return max(newSize, oldCap + oldCap / 2);\n}\n","language":"cpp","meta":""},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"size_t"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-970031"},"children":[{"type":"text","value":"newCapacity"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"size_t"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-441542"},"children":[{"type":"text","value":"newSize"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"size_t"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-441542"},"children":[{"type":"text","value":"oldCap"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-970031"},"children":[{"type":"text","value":"max"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"(newSize, oldCap "}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" oldCap "}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-531245"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":");\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"}"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Example: 15, 31, 47, 70, 105, 157, 235, 352, 528, 792, 1'188, 1'782, 2'673, 4'009."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"GCC libstdc++"}]}]},{"type":"element","tag":"code","props":{"className":["language-cpp"],"code":"size_t newCapacity(size_t newSize, size_t oldCap) {\n    return max(newSize + 1, 2 * oldCap);\n}\n","language":"cpp","meta":""},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"size_t"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-970031"},"children":[{"type":"text","value":"newCapacity"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"size_t"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-441542"},"children":[{"type":"text","value":"newSize"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"size_t"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-441542"},"children":[{"type":"text","value":"oldCap"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-970031"},"children":[{"type":"text","value":"max"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"(newSize "}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-531245"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-531245"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" oldCap);\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"}"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Example: 15, 30, 60, 120, 240, 480, 960, 1'920, 3'840, 7'680, 15'360, 30'720."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"LLVM libc++"}]}]},{"type":"element","tag":"code","props":{"className":["language-cpp"],"code":"size_t newCapacity(size_t newSize, size_t oldCap) {\n    return max(newSize, 2 * oldCap) + 1;\n}\n","language":"cpp","meta":""},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"size_t"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-970031"},"children":[{"type":"text","value":"newCapacity"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"size_t"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-441542"},"children":[{"type":"text","value":"newSize"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"size_t"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-441542"},"children":[{"type":"text","value":"oldCap"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-970031"},"children":[{"type":"text","value":"max"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"(newSize, "}]},{"type":"element","tag":"span","props":{"class":"ct-531245"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" oldCap) "}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-531245"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"}"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Example: 22, 47, 95, 191, 383, 767, 1'535, 3'071, 6'143, 12'287, 24'575, 49'151."}]},{"type":"element","tag":"h2","props":{"id":"summary"},"children":[{"type":"text","value":"Summary"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Because the C++ Standard doesn't provide specific implementation details for "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::string"}]},{"type":"text","value":", there\nare a couple of tradeoffs for the developer of the C++ Standard Library to consider:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Size"}]},{"type":"text","value":": "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"24 bytes"}]},{"type":"text","value":" (LLVM) vs "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"32 bytes"}]},{"type":"text","value":" (GCC, MSVC)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Capacity"}]},{"type":"text","value":": "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"15 chars + Simple Code"}]},{"type":"text","value":" (GCC, MSVC) vs "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"22 chars + Complex Code"}]},{"type":"text","value":" (LLVM)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Growth Policy"}]},{"type":"text","value":": Exponential with "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"1.5x factor"}]},{"type":"text","value":" (MSVC) vs "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"2x factor"}]},{"type":"text","value":" (GCC, LLVM)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In some cases they might be the nice features provided directly by the C++ Standard Library. In\nother situations they might be the limitations, which require extra attention from your side or even\ncompletely new implementation."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Hopefully, these details will make you a better programmer, help write more efficient C++ code, and\ndesign better data structures."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Recommended Links:"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"\"libc++'s implementation of std::string\" by Joel Laity:"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"a","props":{"href":"https://joellaity.com/2020/01/31/string.html","rel":["nofollow"]},"children":[{"type":"text","value":"https://joellaity.com/2020/01/31/string.html"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Discussion on Hacker News:"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"a","props":{"href":"https://news.ycombinator.com/item?id=22198158","rel":["nofollow"]},"children":[{"type":"text","value":"https://news.ycombinator.com/item?id=22198158"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"CppCon 2016: “The strange details of std::string at Facebook\" by Nicholas Ormrod:"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"a","props":{"href":"https://www.youtube.com/watch?v=kPR8h4-qZdk","rel":["nofollow"]},"children":[{"type":"text","value":"https://www.youtube.com/watch?v=kPR8h4-qZdk"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"TastyCode by Oleksandr Gituliar."}]},{"type":"element","tag":"style","children":[{"type":"text","value":".ct-748473{color:#D73A49;}\n.ct-996399{color:#24292E;}\n.ct-970031{color:#6F42C1;}\n.ct-441542{color:#E36209;}\n.ct-531245{color:#005CC5;}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"long-strings","depth":2,"text":"Long Strings"},{"id":"short-strings","depth":2,"text":"Short Strings"},{"id":"memory-allocation-policy","depth":2,"text":"Memory Allocation Policy"},{"id":"summary","depth":2,"text":"Summary"}]}},"_type":"markdown","_id":"content:blog:1.tasty-cpp-memory-layout-of-std-string.md","_source":"content","_file":"blog/1.tasty-cpp-memory-layout-of-std-string.md","_extension":"md"}